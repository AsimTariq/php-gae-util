sudo: false
language: php
php:
- 5.5
- 7.2

before_install:
- phpenv config-rm xdebug.ini
- find ./src -name "*.php" -print0 | xargs -0 -n1 -P8 php -l
- export CLOUDSDK_CORE_PROJECT=php-gae-util-test-project
- export GOOGLE_APPLICATION_CREDENTIALS=$TRAVIS_BUILD_DIR/vendor/google/auth/tests/fixtures/.config/gcloud/application_default_credentials.json
- export SUPPRESS_GCLOUD_CREDS_WARNING=true
- gcloud version || true
- if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash; fi
- source /home/travis/google-cloud-sdk/path.bash.inc
- gcloud version
- gcloud components install beta cloud-datastore-emulator
- nohup gcloud beta emulators datastore start --no-store-on-disk &
- composer global require hirak/prestissimo --no-interaction --no-suggest

install:
- composer install --prefer-source --no-interaction --dev --ignore-platform-reqs --no-suggest

script:
- $(gcloud beta emulators datastore env-init)
- phpunit

cache:
  directories:
  - vendor
  - "$HOME/.cache/composer/files"
  - "$HOME/.composer/cache/files"
  - "$HOME/google-cloud-sdk/"

jobs:
  include:
  - stage: automerge
    before_script:
    - git config --global user.name travis-ci[bot]
    - git config --global user.email travis[bot]@example.com
    - curl -o automerge.sh https://gist.githubusercontent.com/mijohansen/348f1daab99a8f64f2837330a48f3b15/raw/23767acbaca8f12b4e83fae1fc119e9a9d39c2a8/automerge.sh
    - chmod a+x automerge.sh
    script: BRANCHES_TO_MERGE_REGEX='^develop' BRANCH_TO_MERGE_INTO=master ./automerge.sh
    if: branch = develop
    php: 7.1

env:
  global:
    secure: Q8ehzHnM2HjwD4Ofcy2lL4ApYnFyrikTsqGvecyVtJsxr7axl9ALkukEceexxEMvK9zy1j0UqFYmyG4wQyYTlQHErtzGtsxBgzTdGF8OYt0lxQZhm2FS6XWGT1IuM59Zy7aWRYNp3+WX7EeoKbdNzvLvD7aD/p24VmNzz6py7n3jalfrTEdEQMtykISS/yQDgPXSaRvqUDnUr0wVMHlYghBHUiNEtf0PvF2bpfhiU5hsUCD8LcMhzPXCRIvkwxv9vq1SblsFe+s3nQ7w12p/owiLpymgBU3uMYAScuBYwB6fb303FPa9EHDhGo16RZSWHRva58MhiYsa93tidaa5vn7kcIbw7tOW3WZe5sV/VUye8+SJkMnZYbdSNTU1rDCpbkgSTX3vjnmz2JDYcEJXkyVlPa2sfplqleEq4yBovXzR841ILcZl9LDkwaOpOF56nOulh2xJKRm3a6Jr0z/zBsFeIpcHrt2aY8RXaaEldCVJ/VcpfbppkHtawp9toKgQ3HorRSxr0hcwsSS6PS0k6c3y/5Ns22HF1YiRbbk/LA/VkeFFcs9kCL1EZQQ/O9VHy7jDWtqK7L4gwOG7CURol98AUP4C9M5pZcbBeKY4lY73LmIvD8VGBAmSsb6hUQK4+xj7enhZml9eFXFlL00IIiE/DlJLPj1TaHL1ZST6nI0=
